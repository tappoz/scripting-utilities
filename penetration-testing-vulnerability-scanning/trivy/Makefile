# Vulnerability Scanning of any dependency package manager
# on Docker images or File System: apt, yum, node.js, pip, go and so on...

# Common Vulnerabilities and Exposures
# https://www.cve.org/About/Overview
# https://cve.mitre.org/ (old website)
# https://en.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures

# ---------------------------------------------------------------------------------------------------------- #
# this source code is available at:                                                                          #
# https://github.com/tappoz/scripting-utilities/tree/master/penetration-testing-vulnerability-scanning/trivy #
# ---------------------------------------------------------------------------------------------------------- #

# ------------- #
# install trivy #
# ------------- #

# https://aquasecurity.github.io/trivy/v0.20.1/getting-started/installation/
trivy-install:
	sudo apt-get install wget apt-transport-https gnupg lsb-release
	wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
	echo deb https://aquasecurity.github.io/trivy-repo/deb $(shell lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
	sudo apt-get update
	sudo apt-get install trivy

# ------------------ #
# scan docker images #
# ------------------ #

# https://www.debian.org/releases/
# docker image: debian:wheezy-slim
# 2019-MAR-05 more than 2 years old from when we recorded this video
trivy-check-docker-outdated-debian-image:
	trivy image --clear-cache
	trivy image \
		--exit-code 1 \
		--severity HIGH,CRITICAL \
		debian:wheezy-slim

# https://www.debian.org/releases/
# docker image: debian:stretch-slim
# 2021-OCT-12 a few days ago from when we recorded this video
trivy-check-docker-current-debian-lts-image:
	trivy image --clear-cache
	trivy image \
		--exit-code 1 \
		--severity HIGH,CRITICAL \
		debian:stretch-slim

# https://www.debian.org/releases/
# docker image: debian:bullseye-slim
# 2021-OCT-12 a few days ago from when we recorded this video
# 
# https://aquasecurity.github.io/trivy/v0.20.1/vulnerability/examples/filter/
# how to ignore some vulnerabilities:
# .trivyignore with CVE-2021-33574: --ignorefile .trivyignore 
# --ignore-unfixed
trivy-check-docker-current-debian-stable-image:
	trivy image --clear-cache
	trivy image \
		--exit-code 1 \
		--severity HIGH,CRITICAL \
		debian:bullseye-slim

# https://alpinelinux.org/posts/Alpine-3.14.2-released.html
# docker image: alpine:3.14.2
# 2021-AUG-27 a few months ago from when we recorded this video
trivy-check-docker-alpine-latest-image:
	trivy image --clear-cache
	trivy image \
		--exit-code 1 \
		--severity HIGH,CRITICAL \
		alpine:3.14.2

# -------------------------------------- #
# scan programming language dependencies #
# -------------------------------------- #

# https://nodejs.org/en/about/releases/
# latest express.js ^4.17.1
# latest previous major version express.js
# https://github.com/expressjs/express/releases/tag/3.21.2
# 31 Jul 2015: 6 years from when we recorded this video
trivy-check-fs-outdated-nodejs-dep:
	node -v
	trivy filesystem --clear-cache
	trivy filesystem \
		--exit-code 1 \
		--no-progress \
		--severity HIGH,CRITICAL \
		$(PWD)/sample-outdated-nodejs-express-api

# $(HOME)/.local/lib/python3.8/site-packages
# is where `pip` installs Python dependencies
# when you invoke it from the command line 
# e.g. `pip install flask`
trivy-check-fs-outdated-python-dep:
	pip install flask==2.0.2
	trivy filesystem --clear-cache
	trivy filesystem \
		--exit-code 1 \
		--no-progress \
		--severity HIGH,CRITICAL \
		$(HOME)/.local/lib/python3.8/site-packages

# this path `$(HOME)/go/pkg` is the default
# `$GOPATH` where `go` installs dependencies
#
# how to ignore some vulnerabilities
#
# --skip-files $(HOME)/go/pkg/mod/mvdan.cc/gofumpt@v0.1.1/go.sum
trivy-check-fs-outdated-go-dep:
	trivy filesystem --clear-cache
	trivy filesystem \
		--exit-code 1 \
		--no-progress \
		--severity HIGH,CRITICAL \
		$(HOME)/go/pkg

# ---------------------------------------------------------------------------------------------------------- #
# this source code is available at:                                                                          #
# https://github.com/tappoz/scripting-utilities/tree/master/penetration-testing-vulnerability-scanning/trivy #
# ---------------------------------------------------------------------------------------------------------- #
